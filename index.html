<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Bot (Airtable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-3xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Painel de Controle (Airtable)</h1>
        <p class="text-gray-600 mb-6">Este painel se conecta diretamente ao seu banco de dados Airtable para adicionar e remover regras.</p>
        

        <!-- Seção para Adicionar Novas Regras -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Nova Resposta</h2>
            <div class="space-y-4">
                <div>
                    <label for="msg-recebida" class="block text-sm font-medium text-gray-700 mb-1">Se o bot receber (Recebido):</label>
                    <input type="text" id="msg-recebida" placeholder="Ex: oi" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div>
                    <label for="msg-resposta" class="block text-sm font-medium text-gray-700 mb-1">O bot deve responder (Resposta):</label>
                    <input type="text" id="msg-resposta" placeholder="Ex: Olá! Este é um bot." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <button id="btn-add-regra" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200">
                    Adicionar Regra
                </button>
            </div>
        </div>

        <!-- Seção para Ver as Regras Atuais -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Regras Atuais</h2>
                <button id="btn-recarregar" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                    Recarregar
                </button>
            </div>
            <div id="lista-regras" class="space-y-3">
                <p class="text-gray-500 italic">Carregando regras do Airtable...</p>
                <!-- As regras serão injetadas aqui pelo JavaScript -->
            </div>
        </div>
    </div>

    <!-- Div para Pop-ups de Status -->
    <div id="status-popup" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white transition-all duration-300 translate-x-[200%]">
        Mensagem de status
    </div>

    <script>
        // --- Configuração do Airtable ---
        const AIRTABLE_BASE_ID = 'appQpKChWoOGcsHE0'; 
        const AIRTABLE_TOKEN = 'pathYHzTgSzO9jWlj.e25f6fb209fb44a7d5d556f7f539b0aa7369a66432e519290eda84821c400a71';
        const AIRTABLE_TABLE_NAME = 'Bot'; 
        
        // Nomes das colunas (precisa ser IDÊNTICO ao Airtable)
        const COLUNA_RECEBIDO = 'Recebido';
        const COLUNA_RESPOSTA = 'Resposta';

        // URL da API do Airtable
        const API_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`;
        
        // Cabeçalhos de Autenticação
        const AUTH_HEADERS = {
            'Authorization': `Bearer ${AIRTABLE_TOKEN}`,
            'Content-Type': 'application/json'
        };

        // --- Seletores de Elementos ---
        const listaRegrasEl = document.getElementById('lista-regras');
        const btnAdd = document.getElementById('btn-add-regra');
        const btnRecarregar = document.getElementById('btn-recarregar');
        const inputMsg = document.getElementById('msg-recebida');
        const inputResp = document.getElementById('msg-resposta');
        const statusPopup = document.getElementById('status-popup');

        // --- Funções de Feedback (Pop-up) ---
        function mostrarStatus(mensagem, sucesso = true) {
            statusPopup.textContent = mensagem;
            statusPopup.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white transition-all duration-300 ${sucesso ? 'bg-green-600' : 'bg-red-600'} translate-x-0`;
            
            setTimeout(() => {
                statusPopup.className = statusPopup.className.replace('translate-x-0', 'translate-x-[200%]');
            }, 3000);
        }

        // --- Funções da API Airtable ---

        /**
         * 1. BUSCAR (GET) todas as regras do Airtable
         */
        async function carregarRegras() {
            listaRegrasEl.innerHTML = '<p class="text-gray-500 italic">Carregando regras do Airtable...</p>';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: AUTH_HEADERS
                });

                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.statusText}`);
                }

                const data = await response.json();
                renderizarLista(data.records);
            } catch (error) {
                console.error('Erro ao carregar regras:', error);
                listaRegrasEl.innerHTML = '<p class="text-red-500 font-semibold">Falha ao carregar regras. Verifique o console.</p>';
                mostrarStatus('Falha ao carregar regras', false);
            }
        }

        /**
         * 2. ADICIONAR (POST) uma nova regra
         */
        async function adicionarRegra() {
            const msg = inputMsg.value.toLowerCase().trim();
            const resp = inputResp.value.trim();

            if (!msg || !resp) {
                mostrarStatus('Preencha os dois campos!', false);
                return;
            }

            const payload = {
                fields: {
                    [COLUNA_RECEBIDO]: msg,
                    [COLUNA_RESPOSTA]: resp
                }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: AUTH_HEADERS,
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.statusText}`);
                }
                
                inputMsg.value = '';
                inputResp.value = '';
                mostrarStatus('Regra adicionada com sucesso!', true);
                await carregarRegras(); // Recarrega a lista

            } catch (error) {
                console.error('Erro ao adicionar regra:', error);
                mostrarStatus('Falha ao adicionar regra', false);
            }
        }

        /**
         * 3. EXCLUIR (DELETE) uma regra
         */
        async function excluirRegra(recordId) {
            if (!recordId) return;
            
            // Não usamos confirm() pois pode ser bloqueado
            console.log(`Tentando excluir: ${recordId}`);
            
            try {
                const response = await fetch(`${API_URL}/${recordId}`, {
                    method: 'DELETE',
                    headers: AUTH_HEADERS
                });

                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.statusText}`);
                }
                
                mostrarStatus('Regra excluída com sucesso!', true);
                await carregarRegras(); // Recarrega a lista

            } catch (error) {
                console.error('Erro ao excluir regra:', error);
                mostrarStatus('Falha ao excluir regra', false);
            }
        }

        /**
         * 4. RENDERIZAR a lista na tela
         */
        function renderizarLista(records) {
            listaRegrasEl.innerHTML = ''; // Limpa a lista

            if (!records || records.length === 0) {
                listaRegrasEl.innerHTML = '<p class="text-gray-500 italic">Nenhuma regra cadastrada no Airtable.</p>';
                return;
            }

            records.forEach(record => {
                const chave = record.fields[COLUNA_RECEBIDO] || 'N/A';
                const resposta = record.fields[COLUNA_RESPOSTA] || 'N/A';
                const id = record.id; // O ID único do registro no Airtable

                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200';
                
                itemEl.innerHTML = `
                    <div class="flex-1 overflow-hidden mr-4">
                        <p class="text-sm text-gray-800 font-medium truncate">
                            <strong>Receber:</strong> ${chave}
                        </p>
                        <p class="text-sm text-gray-600 truncate">
                            <strong>Responder:</strong> ${resposta}
                        </p>
                    </div>
                    <button 
                        data-id="${id}" 
                        class="btn-excluir flex-shrink-0 bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg text-sm hover:bg-red-200 transition-colors"
                    >
                        Excluir
                    </button>
                `;
                listaRegrasEl.appendChild(itemEl);
            });

            // Adiciona eventos aos novos botões de excluir
            document.querySelectorAll('.btn-excluir').forEach(button => {
                button.addEventListener('click', (e) => {
                    const recordId = e.target.dataset.id;
                    excluirRegra(recordId);
                });
            });
        }

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            // Não precisamos mais da checagem 'SEU_BASE_ID_AQUI' pois já está preenchido
            if (!AIRTABLE_BASE_ID || !AIRTABLE_TOKEN) {
                listaRegrasEl.innerHTML = '<p class="text-red-600 font-bold text-lg">ERRO: Falha ao carregar as chaves da API.</p>';
                return;
            }
            
            // Carrega as regras ao iniciar
            carregarRegras();

            // Adiciona eventos aos botões
            btnAdd.addEventListener('click', adicionarRegra);
            btnRecarregar.addEventListener('click', carregarRegras);
        });
    </script>
</body>
</html>

